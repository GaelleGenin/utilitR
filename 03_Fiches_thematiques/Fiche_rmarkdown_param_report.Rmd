# Produire des rapports automatisés avec `R Markdown` {#rapports-auto}

## Tâches concernées et recommandations

L'utilisateur souhaite réaliser des rapports automatisés, reproductibles et faciles à actualiser en cas de modification des données. Il souhaite également produire de nombreux rapports en modifiant, en fonction de ses besoins, certains paramètres.

::: {.recommandation}
Il est recommandé d'utiliser `R Markdown` pour produire des rapports paramétrés Si vous ne connaissez pas `R Markdown`, il est indispensable de lire au préalable la [fiche `R Markdown`](#R Markdown).
:::

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      fig.pos='H',
                      fig.align = "center",
                      warning=FALSE,
                      message=FALSE)
```

## Les rapports automatisés

### Introduction

Un rapport automatisé est un document qui contient du texte et des informations (graphiques, tableaux...) produites en exécutant un code, appelé code source. Un rapport automatisé peut prendre plusieurs formes :

+ une page internet (un fichier html) ;
+ un document texte (`Word`, `writer`, LaTeX) ;
+ une présentation (_slides_) ;
+ une carte.

Les rapports automatisés présentent deux grands avantages. Premièrement, ils sont reproductibles, car le code source contient toutes les instructions nécessaires à la production des informations contenues dans le rapport. Deuxièmement, ils sont faciles à actualiser en cas de modification des données.

Dans le cas de `R Markdown`, le code source est un fichier texte portant l'extension `.Rmd`. Le document final (ou *output*) est produit après une étape de compilation, en cliquant sur le bouton `knit` de `RStudio`. Le fichier `R Markdown` combine généralement des instructions de traitements des données, mais aussi du texte, des images, des cartes... Les instructions de traitement de données sont généralement rédigées en `R`, mais il est tout à fait possible d'utiliser `R Markdown` avec d'autres langages (par exemple `python`). L'utilisatio de  `R Markdown` est détaillée dans la [fiche `R Markdown`](#R Markdown).

### Quelques bonnes pratiques

Cette section détaille les bonnes pratiques à adopter pour réaliser des rapports automatisés.

### Remplir l'en-tête

Le code source d'un rapport automatisé commence toujours par un en-tête `YAML` qui doit contenir au minimum un titre, une date et un format de sortie. Voici un exemple d'en-tête :

~~~
---
title: "Titre du rapport"
date: '`r format(Sys.time(), "%d %B %Y")`'
output: pdf_document
author: "Anne Onyme"
description: "Une description vraiment utile"
---
~~~

L'en-tête permet de personnaliser finement le document de sortie, par exemple en définissant les options du format de sortie, le positionnement des figures, la présence d'une table des matières... Il existe un nombre considérable d'options, dont certaines sont spécifiques à un format de sortie (pdf, html, ...). La liste des options est détailllée sur le site de la documentation officielle de `R Markdown` et sur l’antisèche et le guide de référence, accessibles depuis RStudio via le menu `Help` puis `Cheatsheets.`

::: {.conseil}
Si vous souhaitez construire un rapport automatisé dont vous allez vous servir souvent, il est vivement conseillé de prendre le temps de définir un en-tête qui correspond précisément à ce que vous voulez produire.
:::


### Configurer les _chunks_

Dans un deuxième temps, il est souhaitable de configurer le comportement par défaut de `R Markdown`. Pour ce faire, `R Markdown` s'appuie en partie sur le *package* `knitr`. Ce dernier est utilisé pour transformer le fichier `R Markdown` en fichier `markdown`. Une fois l'opération réalisée, le *package* `R Markdown` s'occupera de compiler le fichier `markdown` dans le format de sortie fixé dans l'en-tête, *via* le programme `pandoc`.

Voici quelques exemples de configuration :

* position des figures ;
* affichage ou non des instructions `R` dans le fichier de sortie ;
* gestion des messages d'évènement...

Pour ce faire, il est recommandé de commencer son fichier `R Markdown` par un *chunk* de configuration, qui peut ressembler à ceci :

~~~
```{r configuration, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      fig.pos='H',
                      fig.align = "center",
                      warning=FALSE,
                      message=FALSE)
```
~~~

Ici, il est demandé à `R Markdown` de ne pas inclure dans le fichier produit les instructions `R` (`echo = FALSE`). Les figures sont centrées, et dans la mesure du possible positionnées au plus proche de leur ordre d'apparition dans le programme (éviter d'avoir une figure positionnée 2 pages plus loin que leur position souhaitée). Il s'agit des paramètre `fig.pos` et `fig.align`. Les *warnings* et les messages d'informations n'apparaitront pas non plus dans le fichier de sortie.

La fonction `opts_chunk$set` du *package* `knitr` comporte de nombreux paramètres, dont la liste exhaustive est disponible à cette adresse : https://yihui.org/knitr/options/

Les principaux paramètres sont listés ci-dessous :


|   **Paramètre** | **Signification**                                            	|     **Valeur par défaut       	|
|-----------------|---------------------------------------------------------------|---------------------------------|
| echo						| les instructions doivent-elle apparaitre dans l'*output*			| TRUE														|
| eval						| le *chunk* doit-il être évalué (exécuté)											| TRUE														|
| include					| le résultat du *chunk* doit-il être inclus dans l'*output*. Il sera tout de même évalué	| TRUE														|
| results					| contrôle l'affichage du résultat (`markup`, `asis`, ...)			| `markup`												|
| comment					| le caractère qui préfixe le résultat d'une instruction				| ##															|
| cache						| le résultat de l'exécution du code doit-il être mis en cache	| FALSE														|
| fig.width				| taille de la largeur des *plots* (graphiques, cartes)					| 7 (en pouce)										|
| fig.height			| taille de la hauteurs des *plots* (graphiques, cartes)				| 7 (en pouce)										|
| child						| le chemin vers le document "enfant" à intégrer dans le document "parent" | NULL									|
| language				| le moteur d'exécution pour l'instruction											| R																|


::: {.conseil}
Une attention particulière doit être portée sur le paramètre `cache`. Ce dernier permet de signaler à `R Markdown` de ne pas ré-exécuter du code n'ayant pas été modifié depuis le précédent lancement de la compilation. Ceci peut faire gagner beaucoup de temps, notamment pour les *chunks* d'importation de données volumineuses, mais peut parfois conduire à des comportements non souhaités (exemple des données qui sont actualisées, mais dont l'instruction d'importation reste inchangée).
:::

Enfin, il est recommandé de positionner un *chunk* de chargement des librairies utilisées en début de fichier, après la configuration des options de `knitr`.

A titre d'exemple, le *chunk* pourrait ressembler à ceci :

~~~
```{r librairies}
library("doremifasolData")
library("data.table")
```
~~~

Encore une fois, il est conseillé de nommer ces *chunks* de façon non ambigüe, afin de repérer rapidement d'éventuelles erreurs lors de la compilation.

## La production de rapports "de masse" : les rapports paramétrés





Les rapports paramétrés sont une forme particulière de rapports automatisés. Ils présentent donc les mêmes avantages que les rapports automatisés (quasi reproductibles, simple à actualiser), mais permettent d'aller un peu plus loin en terme de fonctionnalités. Il est ainsi possible de générer différents rapports utilisant la même base d'instruction, mais en distinguant les traitements selon un ou plusieurs paramètres à fixer dans l'en-tête `YAML`.

Un court exemple est parfois mieux qu'un long discours, nous allons voir ci-dessous un modèle de rapport "générique" (un *template*), qui peut se décliner selon :

+ différents territoires ;
+ différentes périodicités ;
+ différents code d'une nomenclature...

Bref, selon différents **paramètres**.

Prenons l'exemple très simple d'un utilisateur qui doit générer une table d'effectif de chaque département français.

Pour cela, il peut être tenté de multiplier les fichiers `R Markdown` (`fichierAin.Rmd`, `fichierAisne.Rmd`...).

Cette approche, si elle se justifie lorsque le nombre de document à produire est réduit, voit ses limites lorsqu'il s'agit de réaliser plusieurs dizaines de rapports. C'est à ce moment que le système de rapports paramétrés prend tout son sens.

L'utilisateur a eu vent de la fonctionnalité de rapports paramétrés. Il doit alors réaliser un *template* de document qui s'appliquera de la même façon pour chaque département.

## Un exemple de *template*

Voici un exemple (appelons le `rapportParametre.Rmd`) permettant de répondre au besoin de notre utilisateur :

~~~

---
title: "Mon rapport"
date: "`r Sys.Date()`"
output: pdf_document
params:
  codeDpt: "01"
---

```{r doremisfasol, eval=FALSE, echo=TRUE}
library("doremifasolData")
```

```{r importData, eval=FALSE, echo=TRUE}
cogCom2019 <- doremifasolData::cog_com_2019
```

```{r selectData, eval=FALSE, echo=TRUE}
monDpt <- cogCom2019[cogCom2019$dep %in% params$codeDpt, ]
```

```{r tableData, eval=FALSE, echo=TRUE}
table(monDpt$dep)
```
~~~

La compilation de ce fichier, au travers de la commande `R Markdown::render(input = rapportParametre.Rmd.Rmd)` génèrera le document suivant :

~~~
 01
393
~~~

La fonction `render` permet de transformer un format de fichier (ici `rapportParametre.Rmd`) en un autre, défini dans l'en-tête `YAML`. On remarque que la fonction produit une table d'effectif des communes de l'Ain (département 01) car cette valeur a été définie par défaut dans l'en-tête. Si l'utilisateur souhaite produire le même type de document pour un autre département, il devra **passer explicitement le paramètre `params = list(codeDpt = "XX")`** à la fonction `render`.

```{r tableDpt02, eval=FALSE, echo=TRUE}
R Markdown::render(input = rapportParametre.Rmd, params = list(codeDpt = "02"))
```

Dans cet exemple, l'*output* ressemblera à ceci :

~~~
 02
800
~~~

Il y a donc 800 communes dans l'Aisne.

::: {.conseil}
Il est possible de créer une fonction pour simplifier la génération de rapports paramétrés.
:::

Afin d'illuster ce conseil, voici un exemple de fonction créée *ad hoc* par l'utilisateur désireux de simplifier la production d'un rapport paramétré :

~~~
monRapport <- function(codeDpt) {
	R Markdown::render(input = "rapportParametre.Rmd",
										params = list(codeDpt = codeDpt),
										envir = new.env(),
										output_file = paste0("Rapport_", codeDpt, ".pdf")
	)
}
~~~

Une fois la fonction établie, les rapports se réaliseront *via* la commande :

~~~
monRapport(codeDpt = "02")
~~~

Enfin, cette fonction peut également s'utiliser dans une boucle, au sein d'un autre document `R Markdown` :

~~~
for(i in maListeDeDpt) {
	monRapport(i)
}
~~~

Le modèle de *rapportParametre.Rmd* présenté dans cette fiche est disponible en téléchargement en cliquant sur le lien suivant (insérer lien vers fichier).

# PESP

https://bookdown.org/yihui/R Markdown/parameterized-reports.html
